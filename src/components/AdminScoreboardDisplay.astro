---
// src/components/AdminScoreboardDisplay.astro
const { games } = Astro.props;

const formatDate = (dateString: string) => {
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
  return new Date(dateString).toLocaleDateString('en-US', options);
}

const toTitleCase = (str: string) => {
  if (!str) return '';
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}
---

<div class="scoreboard-grid" id="admin-scoreboard">
  {games.map(game => (
    <div class="game-card" data-game-id={game.id}>
      <div class="game-header">
        <span class="game-date">{formatDate(game.gameDate)}</span>
        <span class="game-level">{toTitleCase(game.teams)}</span>
      </div>
      <div class="game-body">
        <div class="team">
          <span class="team-name">{game.ehs}</span>
          <input type="number" class="team-score-input" value={game.ehsFinal} />
        </div>
        <div class="team">
          <span class="team-name">{game.opp}</span>
          <input type="number" class="team-score-input" value={game.oppFinal} />
        </div>
      </div>
      <div class="game-update-section">
        <div class="update-input-group">
          <input 
            type="text" 
            class="update-text-input" 
            placeholder="Add update note (optional)" 
            data-game-id={game.id}
          />
          <button class="update-button">Update Score</button>
        </div>
        <div class="update-history" id={`update-history-${game.id}`}></div>
      </div>
    </div>
  ))}
</div>

<style>
  .team-score-input {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--navy-blue);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 0.5rem;
    width: 70px;
    text-align: center;
  }

  .update-input-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .update-text-input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.9rem;
  }

  .update-button {
    padding: 0 1.5rem;
    font-size: 0.9rem;
    font-weight: bold;
    color: #ffffff;
    background-color: var(--navy-blue);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    white-space: nowrap;
  }

  .update-button:hover {
    background-color: #003366;
  }

  .update-button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

  .update-history {
    font-size: 0.85rem;
    color: #666;
    max-height: 200px;
    overflow-y: auto;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px solid var(--border-color);
  }

  .update-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid #eee;
  }

  .update-item:last-child {
    border-bottom: none;
  }

  .update-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #888;
    margin-bottom: 0.25rem;
  }

  .update-user {
    font-weight: 600;
    color: var(--navy-blue);
  }

  .update-time {
    font-style: italic;
  }
</style>

<script>
  // Define the Update type for TypeScript
  interface GameUpdate {
    id: number;
    game_id: number;
    user_email: string;
    update_text: string;
    created_at: string;
  }

  // Function to load update history for a game
  async function loadUpdateHistory(gameId: string) {
    try {
      const response = await fetch(`/api/games/${gameId}/updates`);
      if (!response.ok) throw new Error('Failed to load updates');
      
      const updates = await response.json() as GameUpdate[];
      const historyContainer = document.getElementById(`update-history-${gameId}`);
      
      if (!historyContainer) return;
      
      if (updates.length === 0) {
        historyContainer.style.display = 'none';
        return;
      }
      
      historyContainer.style.display = 'block';
      historyContainer.innerHTML = updates.map(update => `
        <div class="update-item">
          <div class="update-meta">
            <span class="update-user">${update.user_email.split('@')[0]}</span>
            <span class="update-time">${new Date(update.created_at).toLocaleString()}</span>
          </div>
          <div class="update-text">${update.update_text}</div>
        </div>
      `).join('');
      
    } catch (error) {
      console.error('Error loading update history:', error);
    }
  }

  // Handle score updates
  document.addEventListener('click', async (event) => {
    const target = event.target as HTMLElement;
    if (!target.classList.contains('update-button')) return;

    const card = target.closest('.game-card') as HTMLElement;
    const gameId = card.dataset.gameId;
    const scoreInputs = card.querySelectorAll('.team-score-input') as NodeListOf<HTMLInputElement>;
    const updateInput = card.querySelector('.update-text-input') as HTMLInputElement;
    const updateText = updateInput?.value.trim() || '';

    const ehsFinal = scoreInputs[0].value;
    const oppFinal = scoreInputs[1].value;

    const buttonText = target.textContent;
    target.textContent = 'Updating...';
    target.setAttribute('disabled', 'true');

    try {
      const response = await fetch(`/api/games/${gameId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          ehsFinal: parseInt(ehsFinal, 10),
          oppFinal: parseInt(oppFinal, 10),
          updateText: updateText
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to update score');
      }

      // Clear the update input
      if (updateInput) {
        updateInput.value = '';
      }

      // Reload the update history
      await loadUpdateHistory(gameId);

      target.textContent = 'Updated!';
      setTimeout(() => {
        target.textContent = buttonText;
        target.removeAttribute('disabled');
      }, 2000);

    } catch (error) {
      console.error('Update Error:', error);
      target.textContent = 'Error!';
      target.style.backgroundColor = '#d9534f';
      setTimeout(() => {
        target.textContent = buttonText;
        target.removeAttribute('disabled');
        target.style.backgroundColor = '';
      }, 3000);
    }
  });

  // Load update history for all games on page load
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.game-card').forEach(card => {
      const gameId = (card as HTMLElement).dataset.gameId;
      if (gameId) {
        loadUpdateHistory(gameId);
      }
    });
  });
</script>
