---
// src/components/ScoreboardFilter.astro
---

<form id="filter-form" class="filter-container">
  <div class="filter-group">
    <label for="search-team">Team Name</label>
    <input type="text" id="search-team" name="team" placeholder="Search for a team...">
  </div>
  <div class="filter-group">
    <label for="filter-teams">Level</label>
    <select id="filter-teams" name="teams">
      <option value="">All Levels</option>
      <option value="Varsity">Varsity</option>
      <option value="Junior Varsity">Junior Varsity</option>
      <option value="Freshmen">Freshmen</option>
    </select>
  </div>
  <div class="filter-group">
    <label for="filter-gameDate">Game Date</label>
    <input type="date" id="filter-gameDate" name="gameDate">
  </div>
  <div class="filter-group">
    <button type="reset">Clear Filters</button>
  </div>
</form>

<style>
  .filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    padding: 1.5rem;
    background-color: #ffffff;
    border-radius: 8px;
    margin-top: 2rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border-color);
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .filter-group label {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .filter-group input,
  .filter-group select {
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 1rem;
  }

  .filter-group button {
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 1rem;
    background-color: var(--light-gray);
    cursor: pointer;
    align-self: flex-end;
    height: 100%;
  }
  
  /* Game Final Status Styling */
  .game-final {
    font-weight: bold;
    color: #d9534f;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 0.25rem 0.5rem;
    border: 1px solid #d9534f;
    border-radius: 3px;
  }
</style>

<script>
  interface GameUpdate {
    id: number;
    game_id: number;
    user_email: string;
    update_text: string;
    created_at: string;
  }

  interface Game {
    id: number;
    gameDate: string;
    teams: string;
    ehs: string;
    ehsScore: number;
    oppScore: number;
    ehsFinal: number;
    opp: string;
    oppFinal: number;
    qtr: string | null;
    timeInqtr: string | null;
    comments: string;
    final?: number;
    updates?: GameUpdate[];
  }

  const formatDate = (dateString: string): string => {
    if (!dateString) return '';
    const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
    return new Date(dateString).toLocaleDateString('en-US', options);
  }

  const toTitleCase = (str: string): string => {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
  }

  // Check if this is the admin page by looking for a data-admin attribute on the scoreboard container
  const isAdmin = document.body.dataset.page === 'admin';

  const createGameCardHTML = (game: Game): string => {
    if (isAdmin) {
      return `
        <div class="game-card" data-game-id="${game.id}">
          <div class="game-header">
            <span class="game-date">${formatDate(game.gameDate)}</span>
            <span class="game-level">${toTitleCase(game.teams)}</span>
          </div>
          <div class="game-body">
            <div class="team">
              <span class="team-name">${game.ehs}</span>
              <input type="number" class="team-score-input" value="${game.ehsFinal}" />
            </div>
            <div class="team">
              <span class="team-name">${game.opp}</span>
              <input type="number" class="team-score-input" value="${game.oppFinal}" />
            </div>
          </div>
          <div class="game-footer">
            <button class="update-button">Update Score</button>
          </div>
        </div>
      `;
    } else {
      // Prepare game status display - show FINAL for completed games
      let statusHTML = '';
      
      if (game.final === 1) {
        statusHTML = `
          <div class="game-status">
            <span class="game-final">FINAL</span>
          </div>
        `;
      } else if (game.qtr || game.timeInqtr) {
        statusHTML = `
          <div class="game-status">
            ${game.qtr ? `<span class="game-quarter">${game.qtr}</span>` : ''}
            ${game.timeInqtr ? `<span class="game-time">${game.timeInqtr}</span>` : ''}
          </div>
        `;
      }
      
      // Prepare updates section if available
      const updatesHTML = game.updates && game.updates.length > 0 ? `
        <div class="game-updates">
          <details class="updates-details">
            <summary class="updates-heading">Recent Updates (${game.updates.length})</summary>
            <ul class="updates-list">
              ${game.updates.map(update => `
                <li class="update-item">
                  <div class="update-row">
                    <span class="update-text" title="${update.update_text}">${update.update_text}</span>
                    <span class="update-timestamp">${update.created_at}</span>
                  </div>
                </li>
              `).join('')}
            </ul>
          </details>
        </div>
      ` : '';
      
      return `
        <div class="game-card">
          <div class="game-header">
            <span class="game-date">${formatDate(game.gameDate)}</span>
            <span class="game-level">${toTitleCase(game.teams)}</span>
          </div>
          <div class="game-body">
            <div class="team">
              <span class="team-name">${game.ehs}</span>
              <span class="team-score">${game.ehsScore !== undefined ? game.ehsScore : game.ehsFinal}</span>
            </div>
            <div class="team">
              <span class="team-name">${game.opp}</span>
              <span class="team-score">${game.oppScore !== undefined ? game.oppScore : game.oppFinal}</span>
            </div>
            ${statusHTML}
          </div>
          <div class="game-footer">
            ${game.comments ? `<p class="game-comment">${game.comments}</p>` : ''}
            ${updatesHTML}
          </div>
        </div>
      `;
    }
  };


  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('filter-form') as HTMLFormElement;
    const scoreboardContainer = document.querySelector('.scoreboard-container');

    if (!form || !scoreboardContainer) {
      return;
    }

    async function fetchAndRenderGames() {
      const formData = new FormData(form);
      const params = new URLSearchParams();

      const team = formData.get('team') as string;
      const teams = formData.get('teams') as string;
      const gameDate = formData.get('gameDate') as string;

      if (team) params.append('team', team);
      if (teams) params.append('teams', teams);
      if (gameDate) params.append('gameDate', gameDate);

      const response = await fetch(`/api/games?${params.toString()}`);
      const games: Game[] = await response.json();
      
      // Fetch updates for each game if they're not already included
      for (const game of games) {
        if (!game.updates) {
          try {
            const updatesResponse = await fetch(`/api/games/${game.id}/updates`);
            if (updatesResponse.ok) {
              game.updates = await updatesResponse.json();
            } else {
              game.updates = [];
            }
          } catch (error) {
            game.updates = [];
          }
        }
      }

      if (games && games.length > 0) {
        const gamesHTML = games.map(createGameCardHTML).join('');
        scoreboardContainer.innerHTML = `<div class="scoreboard-grid">${gamesHTML}</div>`;
        // Attach update button event handler for admin filtered results
        if (isAdmin) {
          scoreboardContainer.querySelectorAll('.update-button').forEach((btn) => {
            btn.addEventListener('click', async (event) => {
              const target = event.target as HTMLElement;
              const card = target.closest('.game-card') as HTMLElement;
              const gameId = card.dataset.gameId;
              const scoreInputs = card.querySelectorAll('.team-score-input') as NodeListOf<HTMLInputElement>;
              const ehsFinal = scoreInputs[0].value;
              const oppFinal = scoreInputs[1].value;
              target.textContent = 'Updating...';
              target.setAttribute('disabled', 'true');
              try {
                const response = await fetch(`/api/games/${gameId}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ ehsFinal: parseInt(ehsFinal, 10), oppFinal: parseInt(oppFinal, 10) }),
                });
                if (!response.ok) throw new Error('Failed to update score');
                target.textContent = 'Updated!';
                setTimeout(() => {
                  target.textContent = 'Update Score';
                  target.removeAttribute('disabled');
                }, 2000);
              } catch (error) {
                target.textContent = 'Error!';
                target.style.backgroundColor = '#d9534f';
                setTimeout(() => {
                  target.textContent = 'Update Score';
                  target.removeAttribute('disabled');
                  target.style.backgroundColor = '';
                }, 3000);
              }
            });
          });
        }
      } else {
        scoreboardContainer.innerHTML = `<p>No games found matching your criteria.</p>`;
      }
    }

    let debounceTimer: number;
    form.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = window.setTimeout(fetchAndRenderGames, 300);
    });

    form.addEventListener('reset', () => {
      setTimeout(fetchAndRenderGames, 0);
    });
  });
</script>
