---
// src/components/ScoreboardFilter.astro
---

<form id="filter-form" class="filter-container">
  <div class="filter-group">
    <label for="search-team">Team Name</label>
    <input type="text" id="search-team" name="team" placeholder="Search for a team...">
  </div>
  <div class="filter-group">
    <label for="filter-teams">Level</label>
    <select id="filter-teams" name="teams">
      <option value="">All Levels</option>
      <option value="Varsity">Varsity</option>
      <option value="Junior Varsity">Junior Varsity</option>
      <option value="Freshmen">Freshmen</option>
    </select>
  </div>
  <div class="filter-group">
    <label for="filter-gameDate">Game Date</label>
    <input type="date" id="filter-gameDate" name="gameDate">
  </div>
  <div class="filter-group">
    <button type="reset">Clear Filters</button>
  </div>
</form>

<style>
  .filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    padding: 1.5rem;
    background-color: #ffffff;
    border-radius: 8px;
    margin-top: 2rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border-color);
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .filter-group label {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .filter-group input,
  .filter-group select {
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 1rem;
  }

  .filter-group button {
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 1rem;
    background-color: var(--light-gray);
    cursor: pointer;
    align-self: flex-end;
    height: 100%;
  }
  
  /* Game Final Status Styling */
  .game-final {
    font-weight: bold;
    color: #d9534f;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 0.25rem 0.5rem;
    border: 1px solid #d9534f;
    border-radius: 3px;
  }
</style>

<script>
  interface GameUpdate {
    id: number;
    game_id: number;
    user_email: string;
    update_text: string;
    created_at: string;
  }

  interface Game {
    id: number;
    gameDate: string;
    teams: string;
    ehs: string;
    ehsScore: number;
    oppScore: number;
    ehsFinal: number;
    opp: string;
    oppFinal: number;
    qtr: string | null;
    timeInqtr: string | null;
    comments: string;
    final?: number;
    updates?: GameUpdate[];
  }

  const formatDate = (dateString: string): string => {
    if (!dateString) return '';
    const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
    return new Date(dateString).toLocaleDateString('en-US', options);
  }

  const toTitleCase = (str: string): string => {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
  }

  // Helpers to lazy-load updates for dynamically rendered cards
  const escapeHtml = (str: string): string => String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/\"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const attachLazyUpdateListeners = (root: Element) => {
    root.querySelectorAll('.game-card[data-game-id]').forEach((cardEl) => {
      const card = cardEl as HTMLElement;
      const gameId = card.getAttribute('data-game-id');
      const details = card.querySelector('.updates-details') as HTMLDetailsElement | null;
      if (!details || !gameId) return;
      const list = card.querySelector('.updates-list') as HTMLElement | null;
      const summary = card.querySelector('.updates-heading') as HTMLElement | null;

      details.addEventListener('toggle', async () => {
        if (!details.open) return;
        if (details.getAttribute('data-loaded') === 'true') return;
        try {
          const res = await fetch(`/api/games/${gameId}/updates`);
          const updates: any[] = res.ok ? await res.json() : [];
          if (summary) {
            summary.textContent = updates.length > 0 ? `Recent Updates (${updates.length})` : 'Recent Updates (0)';
          }
          if (!list) return;
          if (!updates || updates.length === 0) {
            list.innerHTML = '<li class="update-item"><div class="update-row"><span class="update-text">No updates yet</span><span class="update-timestamp"></span></div></li>';
          } else {
            list.innerHTML = updates.map((u: any) =>
              `<li class=\"update-item\"><div class=\"update-row\"><span class=\"update-text\" title=\"${escapeHtml(u.update_text)}\">${escapeHtml(u.update_text)}</span><span class=\"update-timestamp\">${escapeHtml(u.created_at)}</span></div></li>`
            ).join('');
          }
          details.setAttribute('data-loaded', 'true');
        } catch (_) {
          if (summary) summary.textContent = 'Recent Updates (0)';
          if (list) {
            list.innerHTML = '<li class="update-item"><div class="update-row"><span class="update-text">No updates yet</span><span class="update-timestamp"></span></div></li>';
          }
          details.setAttribute('data-loaded', 'true');
        }
      });
    });
  };

  // Check if this is the admin page by looking for a data-admin attribute on the scoreboard container
  const isAdmin = document.body.dataset.page === 'admin';

  const createGameCardHTML = (game: Game): string => {
    if (isAdmin) {
      return `
        <div class="game-card" data-game-id="${game.id}">
          <div class="game-header">
            <span class="game-date">${formatDate(game.gameDate)}</span>
            <span class="game-level">${toTitleCase(game.teams)}</span>
          </div>
          <div class="game-body">
            <div class="team">
              <span class="team-name">${game.ehs}</span>
              <input type="number" class="team-score-input" value="${game.ehsFinal}" />
            </div>
            <div class="team">
              <span class="team-name">${game.opp}</span>
              <input type="number" class="team-score-input" value="${game.oppFinal}" />
            </div>
          </div>
          <div class="game-footer">
            <button class="update-button">Update Score</button>
          </div>
        </div>
      `;
    } else {
      // Prepare game status display - show FINAL for completed games
      let statusHTML = '';
      
      if (game.final === 1) {
        statusHTML = `
          <div class="game-status">
            <span class="game-final">FINAL</span>
          </div>
        `;
      } else if (game.qtr || game.timeInqtr) {
        statusHTML = `
          <div class="game-status">
            ${game.qtr ? `<span class="game-quarter">${game.qtr}</span>` : ''}
            ${game.timeInqtr ? `<span class="game-time">${game.timeInqtr}</span>` : ''}
          </div>
        `;
      }
      
      return `
        <div class="game-card" data-game-id="${game.id}">
          <div class="game-header">
            <span class="game-date">${formatDate(game.gameDate)}</span>
            <span class="game-level">${toTitleCase(game.teams)}</span>
          </div>
          <div class="game-body">
            <div class="team">
              <span class="team-name">${game.ehs}</span>
              <span class="team-score">${game.ehsScore !== undefined ? game.ehsScore : game.ehsFinal}</span>
            </div>
            <div class="team">
              <span class="team-name">${game.opp}</span>
              <span class="team-score">${game.oppScore !== undefined ? game.oppScore : game.oppFinal}</span>
            </div>
            ${statusHTML}
          </div>
          <div class="game-footer">
            ${game.comments ? `<p class="game-comment">${game.comments}</p>` : ''}
            <div class="game-updates">
              <details class="updates-details" data-loaded="false">
                <summary class="updates-heading">Recent Updates</summary>
                <ul class="updates-list" aria-live="polite"></ul>
              </details>
            </div>
          </div>
        </div>
      `;
    }
  };


  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('filter-form') as HTMLFormElement;
    const scoreboardContainer = document.querySelector('.scoreboard-container') as HTMLElement | null;

    if (!form || !scoreboardContainer) {
      return;
    }

    async function fetchAndRenderGames() {
      const formData = new FormData(form);
      const params = new URLSearchParams();

      const team = formData.get('team') as string;
      const teams = formData.get('teams') as string;
      const gameDate = formData.get('gameDate') as string;

      if (team) params.append('team', team);
      if (teams) params.append('teams', teams);
      if (gameDate) params.append('gameDate', gameDate);

      const response = await fetch(`/api/games?${params.toString()}`);
      const games: Game[] = await response.json();

      if (games && games.length > 0 && scoreboardContainer) {
        const gamesHTML = games.map(createGameCardHTML).join('');
        scoreboardContainer.innerHTML = `<div class="scoreboard-grid">${gamesHTML}</div>`;
        attachLazyUpdateListeners(scoreboardContainer);
        // Attach update button event handler for admin filtered results
        if (isAdmin) {
          scoreboardContainer.querySelectorAll('.update-button').forEach((btn) => {
            btn.addEventListener('click', async (event) => {
              const target = event.target as HTMLElement;
              const card = target.closest('.game-card') as HTMLElement;
              const gameId = card.dataset.gameId;
              const scoreInputs = card.querySelectorAll('.team-score-input') as NodeListOf<HTMLInputElement>;
              const ehsFinal = scoreInputs[0].value;
              const oppFinal = scoreInputs[1].value;
              target.textContent = 'Updating...';
              target.setAttribute('disabled', 'true');
              try {
                const response = await fetch(`/api/games/${gameId}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ ehsFinal: parseInt(ehsFinal, 10), oppFinal: parseInt(oppFinal, 10) }),
                });
                if (!response.ok) throw new Error('Failed to update score');
                target.textContent = 'Updated!';
                setTimeout(() => {
                  target.textContent = 'Update Score';
                  target.removeAttribute('disabled');
                }, 2000);
              } catch (error) {
                target.textContent = 'Error!';
                target.style.backgroundColor = '#d9534f';
                setTimeout(() => {
                  target.textContent = 'Update Score';
                  target.removeAttribute('disabled');
                  target.style.backgroundColor = '';
                }, 3000);
              }
            });
          });
        }
      } else {
        scoreboardContainer.innerHTML = `<p>No games found matching your criteria.</p>`;
      }
    }

    let debounceTimer: number;
    form.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = window.setTimeout(fetchAndRenderGames, 300);
    });

    form.addEventListener('reset', () => {
      setTimeout(fetchAndRenderGames, 0);
    });
  });
</script>
