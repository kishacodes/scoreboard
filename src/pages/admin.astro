---
import Layout from '../layouts/Layout.astro';
import ScoreboardFilter from '../components/ScoreboardFilter.astro';
import AdminScoreboardDisplay from '../components/AdminScoreboardDisplay.astro';
import { jwtVerify } from 'jose';

const JWT_SECRET = new TextEncoder().encode('REPLACE_THIS_WITH_A_SECRET_KEY');

// SSR Auth check
const authCookie = Astro.cookies.get('auth')?.value;
if (!authCookie) {
  throw Astro.redirect('/login');
}
try {
  const { payload } = await jwtVerify(authCookie, JWT_SECRET);
  // Optionally check role: if (payload.role !== 'admin') throw Astro.redirect('/login');
  Astro.locals.user = payload;
} catch (e) {
  throw Astro.redirect('/login');
}

// Fetch all games on initial load
const { DB } = Astro.locals.runtime.env;
const { results: games } = await DB.prepare("SELECT * FROM games2025 ORDER BY gameDate DESC").all();
---

<Layout title="Scoreboard Admin - Emerson Knights Football">
	<main class="container">
		<h1>Scoreboard Admin</h1>
		<ScoreboardFilter />
		<div class="scoreboard-container">
			<AdminScoreboardDisplay games={games} />
		</div>
	</main>
</Layout>

<style>
	.container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 2rem;
	}
	h1 {
		font-size: 2.5rem;
		color: var(--navy-blue);
		text-align: center;
		margin-bottom: 2rem;
	}
</style>
