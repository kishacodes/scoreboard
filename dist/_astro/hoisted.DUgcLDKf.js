import"./ScoreboardFilter.astro_astro_type_script_index_0_lang.CM5hcHUm.js";function q(t){if(!t)return new Date(NaN);if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}(?::\d{2})?$/.test(t)){const n=t.replace(" ","T"),o=t.length===16?`${n}:00Z`:`${n}Z`;return new Date(o)}return new Date(t)}function x(t){const e=q(t);return isNaN(e.getTime())?t||"":e.toLocaleString("en-US",{timeZone:"America/Chicago"})}function y(t,e){if(!t.dataset.gameId)return;const o=t.querySelector(".update-history");if(o){if(!e||e.length===0){o.style.display="none";return}o.style.display="block",o.innerHTML=e.map(i=>`
      <div class="update-item">
        <div class="update-meta">
          <span class="update-user">${(i.user_email||"").split("@")[0]}</span>
        </div>
        <div class="update-row">
          <span class="update-text">${i.update_text}</span>
          <span class="update-timestamp">${x(i.created_at)}</span>
        </div>
      </div>
    `).join("")}}async function k(t){try{const e=await fetch(`/api/games/${t}/updates`);if(!e.ok)throw new Error("Failed to load updates");const n=await e.json(),o=document.querySelector(`.game-card[data-game-id="${t}"]`);o&&y(o,n)}catch{}}document.addEventListener("click",async t=>{const e=t.target;if(!e.classList.contains("update-button"))return;const n=e.closest(".game-card"),o=n.dataset.gameId,i=n.querySelectorAll(".team-score-input"),u=n.querySelector(".update-text-input"),m=n.querySelector(".quarter-select"),v=m instanceof HTMLSelectElement?m:null,f=n.querySelector(".time-input"),I=f instanceof HTMLInputElement?f:null,S=n.querySelector(".game-over-checkbox"),T=u?.value.trim()||"",C=v?.value||"",w=I?.value.trim()||"",b=S?.checked||!1,l=i[0].value,d=i[1].value,g=e.textContent;e.textContent="Updating...",e.setAttribute("disabled","true");const p=r=>{document.cookie="auth=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;",localStorage.removeItem("authToken"),window.location.href=`/login?returnTo=${encodeURIComponent(window.location.pathname)}`},h=(()=>{const c=document.cookie.split("; ").find(s=>s.startsWith("auth="));if(c){const s=c.split("=")[1];return decodeURIComponent(s)}const a=localStorage.getItem("authToken");return a||null})();if(!h){p();return}try{const r={ehsScore:parseInt(l,10),oppScore:parseInt(d,10),updateText:T,qtr:C,timeInqtr:w};b&&(r.final=1,r.ehsFinal=parseInt(l,10),r.oppFinal=parseInt(d,10));const c=await fetch(`/api/games/${o}`,{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h.trim()}`},body:JSON.stringify(r)});let a;try{a=await c.json()}catch{throw new Error("Invalid JSON response from server")}if(!c.ok){if(c.status===401){e.textContent="Auth Error",e.style.backgroundColor="#d9534f",setTimeout(()=>{p("Session expired")},500);return}throw new Error(a.error||"Failed to update score")}u&&(u.value="");const s=n.querySelectorAll(".team-score-input");s[0]&&s[1]&&(s[0].value=String(l),s[1].value=String(d)),a.updates&&a.updates.length>0?y(n,a.updates):await k(o),e.textContent="Updated!",setTimeout(()=>{e.textContent=g,e.removeAttribute("disabled")},2e3)}catch(r){if(r instanceof Error&&r.message.includes("token")){p();return}e.textContent="Error!",e.style.backgroundColor="#d9534f",setTimeout(()=>{e.textContent=g,e.removeAttribute("disabled"),e.style.backgroundColor=""},3e3)}});document.addEventListener("DOMContentLoaded",()=>{document.querySelector('[data-page="admin"]')!==null&&document.querySelectorAll(".game-card").forEach(e=>{const n=e.dataset.gameId;n&&k(n)})});
